<!DOCTYPE html>
<html lang="ko">
<head>
<title>폼당폼당</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no, address=no, email=no">
<link href="../css/common.css" type="text/css" rel="stylesheet">
<link href="../css/admin.css" type="text/css" rel="stylesheet">
<script src="../js/jquery-1.12.4.min.js"></script>
</head>
<body>
<div id="login">
	<div class="login-frm">
		<div class="contents">
			<fieldset>
				<legend>그룹입장</legend>
				<h2 class="logo"><img src="../image/common/logo_vertical.png" alt="폼당폼당" class="w6em"></h2>
				<div class="member-login">
					<div class="frm-area">
						<label for="group-id" class="skip">Group</label><input type="text" name="" value="" id="group-id" class="it" placeholder="" disabled readonly>
						<label for="group-pw" class="skip">Password</label><input type="password" name="" value="" id="group-pw" class="it" placeholder="Group Password">
					</div>
					<button type="submit" id="group_login" class="st-fill">입장하기</button>
				</div>
			</fieldset>
		</div>
	</div>
</div>
</body>
<div class="window_alert" id="group_layer">
	<div class="modal-layer">
		<div class="inner">
			<p id="group_comment"></p>
		</div>
		<div class="bt-wrap">
			<button type="button" class="st-fill" id="close_modal" onclick="closeModal()"><span>확인</span></button>
		</div>
	</div>
</div>
<script src="../js/common/f.con.js"></script>
<script src="../js/common.js"></script>
<script>
$(document).ready(function() {
	groun_join()
});

const group_layer = document.getElementById("group_layer");

function openModal(text, url) {
	  group_layer.style.display = "flex";
	  document.body.style.overflow = "hidden";
	  $("#group_comment").text(text);
	  if (![null, undefined, ''].includes(url)) {
		   $("#close_modal").data("url", url);
	  }else {
		   $("#close_modal").data("url", "");
	  }
}

function closeModal() {
	  group_layer.style.display = "none";
	  document.body.style.overflow = "auto";
	  const url = $("#close_modal").data("url")
	  if (![null, undefined, ''].includes(url)) {
		   location.replace(url);
	  }
}


function groun_join() {
    const urlParams = new URLSearchParams(window.location.search);
    const gidValue = urlParams.get('gid');
    const group_session = urlParams.get('group_session');
	const access_token = localStorage.getItem('accessToken')

	if ([null, undefined, ''].includes(access_token)) {
		openModal("로그인 후 그룹에 입장해주세요.", "login.html")
    }

    if (gidValue && group_session) {
        $.ajax({
            type: 'GET',
            url: 'https://formdang-api.com/api/dj/group/join',
            data: {gid: gidValue, group_session: group_session},
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
            },
            success: function (response) {
				if(response.proc == "success") {
					$("#group-id").val(response.group_name);
				}else if(response.proc == "duplicate_001") {
					openModal("그룹장은 가입할 수 없습니다.", `group_status_list.html?gid=${gidValue}&group_session=${group_session}`)
				} else if(response.proc == "duplicate_000"){
					openModal("이미 가입된 그룹입니다.", `group_status_list.html?gid=${gidValue}&group_session=${group_session}`)
				} else {
					openModal("존재하지 않는 그룹입니다.", "index.html")
				}
            },
            error: function (error) {
                alert("유효하지 않은 그룹입니다.");
                location.replace("index.html");
                console.error('AJAX 요청 실패:', error);
            }
        });
    }else {
		openModal("유효하지 않는 그룹입니다.", "index.html")
    }
}


$("#group_login").click(function (event) {
	event.preventDefault();

	const pw = $("#group-pw").val()
	const urlParams = new URLSearchParams(window.location.search);
    const gidValue = urlParams.get('gid');
    const group_session = urlParams.get('group_session');
	const access_token = localStorage.getItem('accessToken')

	if ([null, undefined, ''].includes(pw)) {
		openModal("그룹입장 패스워드를 작성해주세요.");
		return false;
	}

	if ([null, undefined, ''].includes(access_token)) {
		openModal("로그인 후 그룹에 입장해주세요.", "login.html");
		return false;
	}

	if (gidValue && group_session) {
        $.ajax({
            type: 'POST',
            url: 'https://formdang-api.com/api/dj/group/login',
            data: {gid: gidValue, group_session: group_session, password:pw},
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
            },
            success: function (response) {
				if(response.proc == "success") {
					openModal("그룹 가입이 완료되었습니다.", `group_status_list.html?gid=${gidValue}&group_session=${group_session}`);
				}else if(response.proc == "duplicate_001") {
					openModal("그룹장은 가입할 수 없습니다.", `group_status_list.html?gid=${gidValue}&group_session=${group_session}`)
				} else if(response.proc == "duplicate_000"){
					openModal("이미 가입된 그룹입니다.", `group_status_list.html?gid=${gidValue}&group_session=${group_session}`)
				} else if(response.proc == "password") {
					openModal("그룹 정보가 틀렸습니다.");
					return false;
				}else {
					openModal("존재하지 않는 그룹입니다.", "index.html")
				}
            },
            error: function (error) {
                alert("유효하지 않은 그룹입니다.");
                location.replace("index.html");
                console.error('AJAX 요청 실패:', error);
            }
        });
    }else {
		openModal("유효하지 않는 그룹입니다.", "index.html")
    }
})
</script>
</html>
